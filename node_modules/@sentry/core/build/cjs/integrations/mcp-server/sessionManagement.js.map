{"version":3,"file":"sessionManagement.js","sources":["../../../../src/integrations/mcp-server/sessionManagement.ts"],"sourcesContent":["/**\n * Session data management for MCP server instrumentation\n *\n * Uses sessionId as the primary key for stateful transports. This handles the wrapper\n * transport pattern (e.g., NodeStreamableHTTPServerTransport wrapping WebStandardStreamableHTTPServerTransport)\n * where different methods may receive different `this` values but share the same sessionId.\n *\n * Falls back to WeakMap by transport instance for stateless transports (no sessionId).\n */\n\nimport type { MCPTransport, PartyInfo, SessionData } from './types';\n\n/**\n * Session-scoped data storage for stateful transports (with sessionId)\n * @internal Using sessionId as key handles wrapper transport patterns\n */\nconst sessionToSessionData = new Map<string, SessionData>();\n\n/**\n * Transport-scoped data storage fallback for stateless transports (no sessionId)\n * @internal WeakMap allows automatic cleanup when transport is garbage collected\n */\nconst statelessSessionData = new WeakMap<MCPTransport, SessionData>();\n\n/**\n * Gets session data for a transport, checking sessionId first then fallback\n * @internal\n */\nfunction getSessionData(transport: MCPTransport): SessionData | undefined {\n  const sessionId = transport.sessionId;\n  if (sessionId) {\n    return sessionToSessionData.get(sessionId);\n  }\n  return statelessSessionData.get(transport);\n}\n\n/**\n * Sets session data for a transport, using sessionId when available\n * @internal\n */\nfunction setSessionData(transport: MCPTransport, data: SessionData): void {\n  const sessionId = transport.sessionId;\n  if (sessionId) {\n    sessionToSessionData.set(sessionId, data);\n  } else {\n    statelessSessionData.set(transport, data);\n  }\n}\n\n/**\n * Stores session data for a transport\n * @param transport - MCP transport instance\n * @param sessionData - Session data to store\n */\nexport function storeSessionDataForTransport(transport: MCPTransport, sessionData: SessionData): void {\n  // For stateful transports, always store (sessionId is the key)\n  // For stateless transports, also store (transport instance is the key)\n  setSessionData(transport, sessionData);\n}\n\n/**\n * Updates session data for a transport (merges with existing data)\n * @param transport - MCP transport instance\n * @param partialSessionData - Partial session data to merge with existing data\n */\nexport function updateSessionDataForTransport(transport: MCPTransport, partialSessionData: Partial<SessionData>): void {\n  const existingData = getSessionData(transport) || {};\n  setSessionData(transport, { ...existingData, ...partialSessionData });\n}\n\n/**\n * Retrieves client information for a transport\n * @param transport - MCP transport instance\n * @returns Client information if available\n */\nexport function getClientInfoForTransport(transport: MCPTransport): PartyInfo | undefined {\n  return getSessionData(transport)?.clientInfo;\n}\n\n/**\n * Retrieves protocol version for a transport\n * @param transport - MCP transport instance\n * @returns Protocol version if available\n */\nexport function getProtocolVersionForTransport(transport: MCPTransport): string | undefined {\n  return getSessionData(transport)?.protocolVersion;\n}\n\n/**\n * Retrieves full session data for a transport\n * @param transport - MCP transport instance\n * @returns Complete session data if available\n */\nexport function getSessionDataForTransport(transport: MCPTransport): SessionData | undefined {\n  return getSessionData(transport);\n}\n\n/**\n * Cleans up session data for a specific transport (when that transport closes)\n * @param transport - MCP transport instance\n */\nexport function cleanupSessionDataForTransport(transport: MCPTransport): void {\n  const sessionId = transport.sessionId;\n  if (sessionId) {\n    sessionToSessionData.delete(sessionId);\n  }\n  // Note: WeakMap entries are automatically cleaned up when transport is GC'd\n  // No explicit delete needed for statelessSessionData\n}\n"],"names":[],"mappings":";;AAYA;AACA;AACA;AACA;AACA,MAAM,oBAAA,GAAuB,IAAI,GAAG,EAAuB;;AAE3D;AACA;AACA;AACA;AACA,MAAM,oBAAA,GAAuB,IAAI,OAAO,EAA6B;;AAErE;AACA;AACA;AACA;AACA,SAAS,cAAc,CAAC,SAAS,EAAyC;AAC1E,EAAE,MAAM,SAAA,GAAY,SAAS,CAAC,SAAS;AACvC,EAAE,IAAI,SAAS,EAAE;AACjB,IAAI,OAAO,oBAAoB,CAAC,GAAG,CAAC,SAAS,CAAC;AAC9C,EAAE;AACF,EAAE,OAAO,oBAAoB,CAAC,GAAG,CAAC,SAAS,CAAC;AAC5C;;AAEA;AACA;AACA;AACA;AACA,SAAS,cAAc,CAAC,SAAS,EAAgB,IAAI,EAAqB;AAC1E,EAAE,MAAM,SAAA,GAAY,SAAS,CAAC,SAAS;AACvC,EAAE,IAAI,SAAS,EAAE;AACjB,IAAI,oBAAoB,CAAC,GAAG,CAAC,SAAS,EAAE,IAAI,CAAC;AAC7C,EAAE,OAAO;AACT,IAAI,oBAAoB,CAAC,GAAG,CAAC,SAAS,EAAE,IAAI,CAAC;AAC7C,EAAE;AACF;;AAEA;AACA;AACA;AACA;AACA;AACO,SAAS,4BAA4B,CAAC,SAAS,EAAgB,WAAW,EAAqB;AACtG;AACA;AACA,EAAE,cAAc,CAAC,SAAS,EAAE,WAAW,CAAC;AACxC;;AAEA;AACA;AACA;AACA;AACA;AACO,SAAS,6BAA6B,CAAC,SAAS,EAAgB,kBAAkB,EAA8B;AACvH,EAAE,MAAM,eAAe,cAAc,CAAC,SAAS,CAAA,IAAK,EAAE;AACtD,EAAE,cAAc,CAAC,SAAS,EAAE,EAAE,GAAG,YAAY,EAAE,GAAG,kBAAA,EAAoB,CAAC;AACvE;;AAEA;AACA;AACA;AACA;AACA;AACO,SAAS,yBAAyB,CAAC,SAAS,EAAuC;AAC1F,EAAE,OAAO,cAAc,CAAC,SAAS,CAAC,EAAE,UAAU;AAC9C;;AAEA;AACA;AACA;AACA;AACA;AACO,SAAS,8BAA8B,CAAC,SAAS,EAAoC;AAC5F,EAAE,OAAO,cAAc,CAAC,SAAS,CAAC,EAAE,eAAe;AACnD;;AAEA;AACA;AACA;AACA;AACA;AACO,SAAS,0BAA0B,CAAC,SAAS,EAAyC;AAC7F,EAAE,OAAO,cAAc,CAAC,SAAS,CAAC;AAClC;;AAEA;AACA;AACA;AACA;AACO,SAAS,8BAA8B,CAAC,SAAS,EAAsB;AAC9E,EAAE,MAAM,SAAA,GAAY,SAAS,CAAC,SAAS;AACvC,EAAE,IAAI,SAAS,EAAE;AACjB,IAAI,oBAAoB,CAAC,MAAM,CAAC,SAAS,CAAC;AAC1C,EAAE;AACF;AACA;AACA;;;;;;;;;"}