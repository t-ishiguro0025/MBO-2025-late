{"version":3,"file":"wrapServerAction.js","sources":["../../../src/server/wrapServerAction.ts"],"sourcesContent":["import { SEMATTRS_HTTP_TARGET } from '@opentelemetry/semantic-conventions';\nimport type { SpanAttributes } from '@sentry/core';\nimport {\n  debug,\n  flushIfServerless,\n  getActiveSpan,\n  getRootSpan,\n  SEMANTIC_ATTRIBUTE_SENTRY_OP,\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SEMANTIC_ATTRIBUTE_SENTRY_SOURCE,\n  spanToJSON,\n  startSpan,\n  updateSpanName,\n} from '@sentry/core';\nimport type { ActionFunctionArgs } from 'react-router';\nimport { DEBUG_BUILD } from '../common/debug-build';\nimport { isInstrumentationApiUsed } from './serverGlobals';\n\ntype SpanOptions = {\n  name?: string;\n  attributes?: SpanAttributes;\n};\n\n// Track if we've already warned about duplicate instrumentation\nlet hasWarnedAboutDuplicateActionInstrumentation = false;\n\n/**\n * Wraps a React Router server action function with Sentry performance monitoring.\n * @param options - Optional span configuration options including name, operation, description and attributes\n * @param actionFn - The server action function to wrap\n *\n * @example\n * ```ts\n * // Wrap an action function with custom span options\n * export const action = wrapServerAction(\n *   {\n *     name: 'Submit Form Data',\n *     description: 'Processes form submission data',\n *   },\n *   async ({ request }) => {\n *     // ... your action logic\n *   }\n * );\n * ```\n */\nexport function wrapServerAction<T>(\n  options: SpanOptions = {},\n  actionFn: (args: ActionFunctionArgs) => Promise<T>,\n): (args: ActionFunctionArgs) => Promise<T> {\n  return async function (args: ActionFunctionArgs): Promise<T> {\n    // Skip instrumentation if instrumentation API is already handling it\n    if (isInstrumentationApiUsed()) {\n      if (DEBUG_BUILD && !hasWarnedAboutDuplicateActionInstrumentation) {\n        hasWarnedAboutDuplicateActionInstrumentation = true;\n        debug.warn(\n          'wrapServerAction is redundant when using the instrumentation API. ' +\n            'The action is already instrumented automatically. You can safely remove wrapServerAction.',\n        );\n      }\n      return actionFn(args);\n    }\n\n    const name = options.name || 'Executing Server Action';\n    const active = getActiveSpan();\n    if (active) {\n      const root = getRootSpan(active);\n      const spanData = spanToJSON(root);\n      if (spanData.origin === 'auto.http.otel.http') {\n        // eslint-disable-next-line deprecation/deprecation\n        const target = spanData.data[SEMATTRS_HTTP_TARGET];\n\n        if (target) {\n          // We cannot rely on the regular span name inferral here, as the express instrumentation sets `*` as the route\n          // So we force this to be a more sensible name here\n          updateSpanName(root, `${args.request.method} ${target}`);\n          root.setAttributes({\n            [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: 'url',\n            [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.http.react_router.action',\n          });\n        }\n      }\n    }\n\n    try {\n      return await startSpan(\n        {\n          name,\n          ...options,\n          attributes: {\n            [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.http.react_router.action',\n            [SEMANTIC_ATTRIBUTE_SENTRY_OP]: 'function.react_router.action',\n            ...options.attributes,\n          },\n        },\n        () => actionFn(args),\n      );\n    } finally {\n      await flushIfServerless();\n    }\n  };\n}\n"],"names":["isInstrumentationApiUsed","DEBUG_BUILD","debug","getActiveSpan","getRootSpan","spanToJSON","SEMATTRS_HTTP_TARGET","updateSpanName","SEMANTIC_ATTRIBUTE_SENTRY_SOURCE","SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN","startSpan","SEMANTIC_ATTRIBUTE_SENTRY_OP","flushIfServerless"],"mappings":";;;;;;;AAuBA;AACA,IAAI,4CAAA,GAA+C,KAAK;;AAExD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,gBAAgB;AAChC,EAAE,OAAO,GAAgB,EAAE;AAC3B,EAAE,QAAQ;AACV,EAA4C;AAC5C,EAAE,OAAO,gBAAgB,IAAI,EAAkC;AAC/D;AACA,IAAI,IAAIA,sCAAwB,EAAE,EAAE;AACpC,MAAM,IAAIC,sBAAA,IAAe,CAAC,4CAA4C,EAAE;AACxE,QAAQ,4CAAA,GAA+C,IAAI;AAC3D,QAAQC,UAAK,CAAC,IAAI;AAClB,UAAU,oEAAA;AACV,YAAY,2FAA2F;AACvG,SAAS;AACT,MAAM;AACN,MAAM,OAAO,QAAQ,CAAC,IAAI,CAAC;AAC3B,IAAI;;AAEJ,IAAI,MAAM,IAAA,GAAO,OAAO,CAAC,IAAA,IAAQ,yBAAyB;AAC1D,IAAI,MAAM,MAAA,GAASC,kBAAa,EAAE;AAClC,IAAI,IAAI,MAAM,EAAE;AAChB,MAAM,MAAM,IAAA,GAAOC,gBAAW,CAAC,MAAM,CAAC;AACtC,MAAM,MAAM,QAAA,GAAWC,eAAU,CAAC,IAAI,CAAC;AACvC,MAAM,IAAI,QAAQ,CAAC,MAAA,KAAW,qBAAqB,EAAE;AACrD;AACA,QAAQ,MAAM,SAAS,QAAQ,CAAC,IAAI,CAACC,wCAAoB,CAAC;;AAE1D,QAAQ,IAAI,MAAM,EAAE;AACpB;AACA;AACA,UAAUC,mBAAc,CAAC,IAAI,EAAE,CAAC,EAAA,IAAA,CAAA,OAAA,CAAA,MAAA,CAAA,CAAA,EAAA,MAAA,CAAA,CAAA,CAAA;AACA,UAAA,IAAA,CAAA,aAAA,CAAA;AACA,YAAA,CAAAC,qCAAA,GAAA,KAAA;AACA,YAAA,CAAAC,qCAAA,GAAA,+BAAA;AACA,WAAA,CAAA;AACA,QAAA;AACA,MAAA;AACA,IAAA;;AAEA,IAAA,IAAA;AACA,MAAA,OAAA,MAAAC,cAAA;AACA,QAAA;AACA,UAAA,IAAA;AACA,UAAA,GAAA,OAAA;AACA,UAAA,UAAA,EAAA;AACA,YAAA,CAAAD,qCAAA,GAAA,+BAAA;AACA,YAAA,CAAAE,iCAAA,GAAA,8BAAA;AACA,YAAA,GAAA,OAAA,CAAA,UAAA;AACA,WAAA;AACA,SAAA;AACA,QAAA,MAAA,QAAA,CAAA,IAAA,CAAA;AACA,OAAA;AACA,IAAA,CAAA,SAAA;AACA,MAAA,MAAAC,sBAAA,EAAA;AACA,IAAA;AACA,EAAA,CAAA;AACA;;;;"}