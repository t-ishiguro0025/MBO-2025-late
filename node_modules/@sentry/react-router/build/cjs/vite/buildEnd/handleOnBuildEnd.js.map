{"version":3,"file":"handleOnBuildEnd.js","sources":["../../../../src/vite/buildEnd/handleOnBuildEnd.ts"],"sourcesContent":["import { rm } from 'node:fs/promises';\nimport type { Config } from '@react-router/dev/config';\nimport SentryCli from '@sentry/cli';\nimport type { SentryVitePluginOptions } from '@sentry/vite-plugin';\nimport { glob } from 'glob';\nimport type { SentryReactRouterBuildOptions } from '../types';\n\ntype BuildEndHook = NonNullable<Config['buildEnd']>;\n\nfunction getSentryConfig(viteConfig: unknown): SentryReactRouterBuildOptions {\n  if (!viteConfig || typeof viteConfig !== 'object' || !('sentryConfig' in viteConfig)) {\n    // eslint-disable-next-line no-console\n    console.error('[Sentry] sentryConfig not found - it needs to be passed to vite.config.ts');\n  }\n\n  return (viteConfig as { sentryConfig: SentryReactRouterBuildOptions }).sentryConfig;\n}\n\n/**\n * A build end hook that handles Sentry release creation and source map uploads.\n * It creates a new Sentry release if configured, uploads source maps to Sentry,\n * and optionally deletes the source map files after upload.\n */\nexport const sentryOnBuildEnd: BuildEndHook = async ({ reactRouterConfig, viteConfig }) => {\n  const sentryConfig = getSentryConfig(viteConfig);\n\n  // todo(v11): Remove deprecated sourceMapsUploadOptions support (no need for spread/pick anymore)\n  const {\n    sourceMapsUploadOptions, // extract to exclude from rest config\n    ...sentryConfigWithoutDeprecatedSourceMapOption\n  } = sentryConfig;\n\n  const unstableSentryVitePluginOptions = sentryConfig.unstable_sentryVitePluginOptions;\n\n  const {\n    authToken,\n    org,\n    project,\n    release,\n    sourcemaps = { disable: false },\n    debug = false,\n  }: Omit<SentryReactRouterBuildOptions, 'sourcemaps' | 'sourceMapsUploadOptions'> &\n    // Pick 'sourcemaps' from Vite plugin options as the types allow more (e.g. Promise values for `deleteFilesAfterUpload`)\n    Pick<SentryVitePluginOptions, 'sourcemaps'> = {\n    ...unstableSentryVitePluginOptions,\n    ...sentryConfigWithoutDeprecatedSourceMapOption, // spread in the config without the deprecated sourceMapsUploadOptions\n    sourcemaps: {\n      ...unstableSentryVitePluginOptions?.sourcemaps,\n      ...sentryConfig.sourcemaps,\n      ...sourceMapsUploadOptions,\n      // eslint-disable-next-line deprecation/deprecation\n      disable: sourceMapsUploadOptions?.enabled === false ? true : sentryConfig.sourcemaps?.disable,\n    },\n    release: {\n      ...unstableSentryVitePluginOptions?.release,\n      ...sentryConfig.release,\n    },\n    project: unstableSentryVitePluginOptions?.project\n      ? Array.isArray(unstableSentryVitePluginOptions?.project)\n        ? unstableSentryVitePluginOptions?.project[0]\n        : unstableSentryVitePluginOptions?.project\n      : sentryConfigWithoutDeprecatedSourceMapOption.project,\n  };\n\n  const cliInstance = new SentryCli(null, {\n    authToken,\n    org,\n    ...sentryConfig.unstable_sentryVitePluginOptions,\n    // same handling as in bundler plugins: https://github.com/getsentry/sentry-javascript-bundler-plugins/blob/05084f214c763a05137d863ff5a05ef38254f68d/packages/bundler-plugin-core/src/build-plugin-manager.ts#L102-L103\n    project: Array.isArray(project) ? project[0] : project,\n  });\n\n  // check if release should be created\n  if (release?.name) {\n    try {\n      await cliInstance.releases.new(release.name);\n    } catch (error) {\n      // eslint-disable-next-line no-console\n      console.error('[Sentry] Could not create release', error);\n    }\n  }\n\n  if (!sourcemaps?.disable && viteConfig.build.sourcemap !== false) {\n    // inject debugIds\n    try {\n      await cliInstance.execute(\n        ['sourcemaps', 'inject', reactRouterConfig.buildDirectory],\n        debug ? 'rejectOnError' : false,\n      );\n    } catch (error) {\n      // eslint-disable-next-line no-console\n      console.error('[Sentry] Could not inject debug ids', error);\n    }\n\n    // upload sourcemaps\n    try {\n      await cliInstance.releases.uploadSourceMaps(release?.name || 'undefined', {\n        include: [\n          {\n            paths: [reactRouterConfig.buildDirectory],\n          },\n        ],\n        live: 'rejectOnError',\n      });\n    } catch (error) {\n      // eslint-disable-next-line no-console\n      console.error('[Sentry] Could not upload sourcemaps', error);\n    }\n  }\n  // delete sourcemaps after upload\n  let updatedFilesToDeleteAfterUpload = await sourcemaps?.filesToDeleteAfterUpload;\n\n  // set a default value no option was set\n  if (typeof updatedFilesToDeleteAfterUpload === 'undefined') {\n    updatedFilesToDeleteAfterUpload = [`${reactRouterConfig.buildDirectory}/**/*.map`];\n    debug &&\n      // eslint-disable-next-line no-console\n      console.info(\n        `[Sentry] Automatically setting \\`sourceMapsUploadOptions.filesToDeleteAfterUpload: ${JSON.stringify(\n          updatedFilesToDeleteAfterUpload,\n        )}\\` to delete generated source maps after they were uploaded to Sentry.`,\n      );\n  }\n  if (updatedFilesToDeleteAfterUpload) {\n    try {\n      const filePathsToDelete = await glob(updatedFilesToDeleteAfterUpload, {\n        absolute: true,\n        nodir: true,\n      });\n      if (debug) {\n        filePathsToDelete.forEach(filePathToDelete => {\n          // eslint-disable-next-line no-console\n          console.info(`Deleting asset after upload: ${filePathToDelete}`);\n        });\n      }\n      await Promise.all(\n        filePathsToDelete.map(filePathToDelete =>\n          rm(filePathToDelete, { force: true }).catch((e: unknown) => {\n            // This is allowed to fail - we just don't do anything\n            debug &&\n              // eslint-disable-next-line no-console\n              console.debug(`An error occurred while attempting to delete asset: ${filePathToDelete}`, e);\n          }),\n        ),\n      );\n    } catch (error) {\n      // eslint-disable-next-line no-console\n      console.error('Error deleting files after sourcemap upload:', error);\n    }\n  }\n};\n"],"names":["SentryCli","glob","rm"],"mappings":"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"}