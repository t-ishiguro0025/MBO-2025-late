{"version":3,"file":"wrapServerLoader.js","sources":["../../../src/server/wrapServerLoader.ts"],"sourcesContent":["import { SEMATTRS_HTTP_TARGET } from '@opentelemetry/semantic-conventions';\nimport type { SpanAttributes } from '@sentry/core';\nimport {\n  debug,\n  flushIfServerless,\n  getActiveSpan,\n  getRootSpan,\n  SEMANTIC_ATTRIBUTE_SENTRY_OP,\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SEMANTIC_ATTRIBUTE_SENTRY_SOURCE,\n  spanToJSON,\n  startSpan,\n  updateSpanName,\n} from '@sentry/core';\nimport type { LoaderFunctionArgs } from 'react-router';\nimport { DEBUG_BUILD } from '../common/debug-build';\nimport { isInstrumentationApiUsed } from './serverGlobals';\n\ntype SpanOptions = {\n  name?: string;\n  attributes?: SpanAttributes;\n};\n\n// Track if we've already warned about duplicate instrumentation\nlet hasWarnedAboutDuplicateLoaderInstrumentation = false;\n\n/**\n * Wraps a React Router server loader function with Sentry performance monitoring.\n * @param options - Optional span configuration options including name, operation, description and attributes\n * @param loaderFn - The server loader function to wrap\n *\n * @example\n * ```ts\n * // Wrap a loader function with custom span options\n * export const loader = wrapServerLoader(\n *   {\n *     name: 'Load Some Data',\n *     description: 'Loads some data from the db',\n *   },\n *   async ({ params }) => {\n *     // ... your loader logic\n *   }\n * );\n * ```\n */\nexport function wrapServerLoader<T>(\n  options: SpanOptions = {},\n  loaderFn: (args: LoaderFunctionArgs) => Promise<T>,\n): (args: LoaderFunctionArgs) => Promise<T> {\n  return async function (args: LoaderFunctionArgs): Promise<T> {\n    // Skip instrumentation if instrumentation API is already handling it\n    if (isInstrumentationApiUsed()) {\n      if (DEBUG_BUILD && !hasWarnedAboutDuplicateLoaderInstrumentation) {\n        hasWarnedAboutDuplicateLoaderInstrumentation = true;\n        debug.warn(\n          'wrapServerLoader is redundant when using the instrumentation API. ' +\n            'The loader is already instrumented automatically. You can safely remove wrapServerLoader.',\n        );\n      }\n      return loaderFn(args);\n    }\n\n    const name = options.name || 'Executing Server Loader';\n    const active = getActiveSpan();\n\n    if (active) {\n      const root = getRootSpan(active);\n      const spanData = spanToJSON(root);\n      if (spanData.origin === 'auto.http.otel.http') {\n        // eslint-disable-next-line deprecation/deprecation\n        const target = spanData.data[SEMATTRS_HTTP_TARGET];\n\n        if (target) {\n          // We cannot rely on the regular span name inferral here, as the express instrumentation sets `*` as the route\n          // So we force this to be a more sensible name here\n          updateSpanName(root, `${args.request.method} ${target}`);\n          root.setAttributes({\n            [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: 'url',\n            [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.http.react_router.loader',\n          });\n        }\n      }\n    }\n    try {\n      return await startSpan(\n        {\n          name,\n          ...options,\n          attributes: {\n            [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.http.react_router.loader',\n            [SEMANTIC_ATTRIBUTE_SENTRY_OP]: 'function.react_router.loader',\n            ...options.attributes,\n          },\n        },\n        () => loaderFn(args),\n      );\n    } finally {\n      await flushIfServerless();\n    }\n  };\n}\n"],"names":[],"mappings":";;;;;AAuBA;AACA,IAAI,4CAAA,GAA+C,KAAK;;AAExD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,gBAAgB;AAChC,EAAE,OAAO,GAAgB,EAAE;AAC3B,EAAE,QAAQ;AACV,EAA4C;AAC5C,EAAE,OAAO,gBAAgB,IAAI,EAAkC;AAC/D;AACA,IAAI,IAAI,wBAAwB,EAAE,EAAE;AACpC,MAAM,IAAI,WAAA,IAAe,CAAC,4CAA4C,EAAE;AACxE,QAAQ,4CAAA,GAA+C,IAAI;AAC3D,QAAQ,KAAK,CAAC,IAAI;AAClB,UAAU,oEAAA;AACV,YAAY,2FAA2F;AACvG,SAAS;AACT,MAAM;AACN,MAAM,OAAO,QAAQ,CAAC,IAAI,CAAC;AAC3B,IAAI;;AAEJ,IAAI,MAAM,IAAA,GAAO,OAAO,CAAC,IAAA,IAAQ,yBAAyB;AAC1D,IAAI,MAAM,MAAA,GAAS,aAAa,EAAE;;AAElC,IAAI,IAAI,MAAM,EAAE;AAChB,MAAM,MAAM,IAAA,GAAO,WAAW,CAAC,MAAM,CAAC;AACtC,MAAM,MAAM,QAAA,GAAW,UAAU,CAAC,IAAI,CAAC;AACvC,MAAM,IAAI,QAAQ,CAAC,MAAA,KAAW,qBAAqB,EAAE;AACrD;AACA,QAAQ,MAAM,SAAS,QAAQ,CAAC,IAAI,CAAC,oBAAoB,CAAC;;AAE1D,QAAQ,IAAI,MAAM,EAAE;AACpB;AACA;AACA,UAAU,cAAc,CAAC,IAAI,EAAE,CAAC,EAAA,IAAA,CAAA,OAAA,CAAA,MAAA,CAAA,CAAA,EAAA,MAAA,CAAA,CAAA,CAAA;AACA,UAAA,IAAA,CAAA,aAAA,CAAA;AACA,YAAA,CAAA,gCAAA,GAAA,KAAA;AACA,YAAA,CAAA,gCAAA,GAAA,+BAAA;AACA,WAAA,CAAA;AACA,QAAA;AACA,MAAA;AACA,IAAA;AACA,IAAA,IAAA;AACA,MAAA,OAAA,MAAA,SAAA;AACA,QAAA;AACA,UAAA,IAAA;AACA,UAAA,GAAA,OAAA;AACA,UAAA,UAAA,EAAA;AACA,YAAA,CAAA,gCAAA,GAAA,+BAAA;AACA,YAAA,CAAA,4BAAA,GAAA,8BAAA;AACA,YAAA,GAAA,OAAA,CAAA,UAAA;AACA,WAAA;AACA,SAAA;AACA,QAAA,MAAA,QAAA,CAAA,IAAA,CAAA;AACA,OAAA;AACA,IAAA,CAAA,SAAA;AACA,MAAA,MAAA,iBAAA,EAAA;AACA,IAAA;AACA,EAAA,CAAA;AACA;;;;"}